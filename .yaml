openapi: 3.0.0
info:
  title: "FitConnect API - End-to-End Payment"
  version: "1.0.0"
  description: |
    API FitConnect untuk workout tracking, appointment dengan dokter,
    diagnosa, resep obat, dan pembayaran konsultasi + obat.

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Users
  - name: Workouts
  - name: Exercises
  - name: Exercise Logs
  - name: Doctors
  - name: Appointments
  - name: Diagnoses
  - name: Billings
  - name: Invoices

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id: { type: integer }
        full_name: { type: string }
        email: { type: string }
        weight: { type: number, format: float }
        height: { type: integer }

    Workout:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        goals: { type: string }
        user_id: { type: integer }

    Exercise:
      type: object
      properties:
        id: { type: integer }
        workout_id: { type: integer }
        name: { type: string }
        description: { type: string }
        sets: { type: string, example: "3-4" }
        reps: { type: string, example: "10-15" }
        equipment: { type: string }

    ExerciseLog:
      type: object
      properties:
        id: { type: integer }
        exercise_id: { type: integer }
        user_id: { type: integer }
        set_count: { type: integer }
        rep_count: { type: integer }
        weight: { type: number, format: float }
        created_at: { type: string, format: date-time }

    Doctor:
      type: object
      properties:
        id: { type: integer }
        full_name: { type: string }
        specialization: { type: string }
        email: { type: string }

    Appointment:
      type: object
      properties:
        id: { type: integer }
        user_id: { type: integer }
        doctor_id: { type: integer }
        appointment_date: { type: string, format: date-time }
        status: { type: string, enum: [pending, confirmed, completed, cancelled] }
        notes: { type: string }

    Diagnosis:
      type: object
      properties:
        id: { type: integer }
        appointment_id: { type: integer }
        doctor_id: { type: integer }
        notes: { type: string }
        prescribed_medications: { type: string }

    Billing:
      type: object
      properties:
        id: { type: integer }
        appointment_id: { type: integer }
        total_amount: { type: number, format: float }
        payment_status: { type: string, enum: [unpaid, waiting_payment, paid, failed] }
        invoice_url: { type: string }
        created_at: { type: string, format: date-time }
        paid_at: { type: string, format: date-time }

    Invoice:
      type: object
      properties:
        id: { type: integer }
        billing_id: { type: integer }
        user_id: { type: integer }
        doctor_id: { type: integer }
        consultation_fee: { type: number, format: float }
        medication_cost: { type: number, format: float }
        total_amount: { type: number, format: float }
        invoice_date: { type: string, format: date-time }
        created_at: { type: string, format: date-time }

paths:

  # Users
  /users/register:
    post:
      tags: [Users]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [full_name, email, password, weight, height]
              properties:
                full_name: { type: string }
                email: { type: string }
                password: { type: string }
                weight: { type: number, format: float }
                height: { type: integer }
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/User"

  /users/login:
    post:
      tags: [Users]
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string }
                password: { type: string }
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  access_token: { type: string }

  /users:
    get:
      tags: [Users]
      summary: Get current user profile (with BMI)
      security: [{ BearerAuth: [] }]
      responses:
        "200":
          description: User profile with calculated BMI
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    type: object
                    properties:
                      id: { type: integer }
                      full_name: { type: string }
                      email: { type: string }
                      weight: { type: number, format: float }
                      height: { type: number, format: float }
                      bmi: { type: number, format: float }
                      bmi_category: { type: string }

  # Workouts
  /workouts/preview:
    post:
      tags: [Workouts]
      summary: Preview workout with AI-generated exercises (Gemini)
      description: Generate workout preview with exercises using Gemini AI without saving to database
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [workout_name, goals]
              properties:
                workout_name: { type: string, example: "Morning Cardio" }
                goals: { type: string, example: "Improve cardiovascular health and burn calories" }
      responses:
        "200":
          description: Workout preview with AI-generated exercises
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    type: object
                    properties:
                      workout_name:
                        type: object
                        properties:
                          workout_name: { type: string }
                          goals: { type: string }
                      exercises:
                        type: array
                        items:
                          type: object
                          properties:
                            name: { type: string }
                            sets: { type: string, example: "3-4" }
                            reps: { type: string, example: "10-15" }
                            equipment: { type: string }

  /workouts:
    get:
      tags: [Workouts]
      summary: Get all workouts for logged user
      security: [{ BearerAuth: [] }]
      responses:
        "200":
          description: List of workouts
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  workouts:
                    type: array
                    items:
                      $ref: "#/components/schemas/Workout"

    post:
      tags: [Workouts]
      summary: Save workout with exercises to database
      description: Create and save workout with selected exercises
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [workout_name, exercises]
              properties:
                workout_name:
                  type: object
                  required: [workout_name, goals]
                  properties:
                    workout_name: { type: string }
                    goals: { type: string }
                exercises:
                  type: array
                  items:
                    type: object
                    required: [name]
                    properties:
                      name: { type: string }
                      sets: { type: string }
                      reps: { type: string }
                      equipment: { type: string }
      responses:
        "201":
          description: Workout created and saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    type: object
                    properties:
                      workout_name:
                        $ref: "#/components/schemas/Workout"
                      exercises:
                        type: array
                        items:
                          type: object
                          properties:
                            name: { type: string }
                            sets: { type: string }
                            reps: { type: string }
                            equipment: { type: string }

  /workouts/{id}:
    get:
      tags: [Workouts]
      summary: Get workout details by ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Workout detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Workout"

    delete:
      tags: [Workouts]
      summary: Delete workout
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Workout deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }

  # Exercises
  /exercises:
    post:
      tags: [Exercises]
      summary: Create exercise for a workout
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [workout_id, name, description]
              properties:
                workout_id: { type: integer }
                name: { type: string }
                description: { type: string }
                sets: { type: string, example: "3-4" }
                reps: { type: string, example: "10-15" }
                equipment: { type: string }
      responses:
        "201":
          description: Exercise created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Exercise"

  /exercises/{id}:
    get:
      tags: [Exercises]
      summary: Get exercises by workout ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: Workout ID
      responses:
        "200":
          description: List of exercises for the workout
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  exercises:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: integer }
                        exercise_name: { type: string }
                        sets: { type: string }
                        reps: { type: string }
                        equipment: { type: string }

    put:
      tags: [Exercises]
      summary: Update exercise
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: Exercise ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [workout_id, name, description]
              properties:
                workout_id: { type: integer }
                name: { type: string }
                description: { type: string }
                sets: { type: string }
                reps: { type: string }
                equipment: { type: string }
      responses:
        "200":
          description: Exercise updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Exercise"

    delete:
      tags: [Exercises]
      summary: Delete exercise
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: Exercise ID
      responses:
        "200":
          description: Exercise deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }

  # Exercise Logs
  /logs:
    get:
      tags: [Exercise Logs]
      summary: Get user exercise logs
      security: [{ BearerAuth: [] }]
      responses:
        "200":
          description: List of exercise logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ExerciseLog"

    post:
      tags: [Exercise Logs]
      summary: Create exercise log
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [exercise_id, set_count, rep_count, weight]
              properties:
                exercise_id: { type: integer }
                set_count: { type: integer }
                rep_count: { type: integer }
                weight: { type: number, format: float }
      responses:
        "201":
          description: Log created

  # Doctors
  /doctors/register:
    post:
      tags: [Doctors]
      summary: Register new doctor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [full_name, email, password, specialization]
              properties:
                full_name: { type: string }
                email: { type: string }
                password: { type: string }
                specialization: { type: string }
      responses:
        "201":
          description: Doctor registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Doctor"

  /doctors/login:
    post:
      tags: [Doctors]
      summary: Login doctor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string }
                password: { type: string }
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  access_token: { type: string }

  /doctors:
    get:
      tags: [Doctors]
      summary: List all doctors
      security: [{ BearerAuth: [] }]
      responses:
        "200":
          description: List of doctors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Doctor"

  # Appointments
  /appointments:
    get:
      tags: [Appointments]
      summary: List user appointments
      security: [{ BearerAuth: [] }]
      responses:
        "200":
          description: List of appointments
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Appointment"

    post:
      tags: [Appointments]
      summary: Create new appointment
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [doctor_id, appointment_date]
              properties:
                doctor_id: { type: integer }
                appointment_date: { type: string, format: date-time, example: "2025-11-10T10:00:00Z" }
                notes: { type: string }
      responses:
        "201":
          description: Appointment created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Appointment"
        "409":
          description: Doctor is not available at the requested time
          content:
            application/json:
              schema:
                type: object
                properties:
                  error: { type: string }

  /appointments/{id}:
    get:
      tags: [Appointments]
      summary: Get appointment by ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Appointment details
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Appointment"

  # Billings
  /billings:
    post:
      tags: [Billings]
      summary: Create new billing for an appointment
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [appointment_id, total_amount]
              properties:
                appointment_id: { type: integer }
                total_amount: { type: number, format: float }
                external_id: { type: string }
                invoice_url: { type: string }
      responses:
        "201":
          description: Billing created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Billing"

  /billings/{id}:
    get:
      tags: [Billings]
      summary: Get billing details by ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Billing details
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Billing"

  /billings/appointment/{appointment_id}:
    get:
      tags: [Billings]
      summary: Get billing by appointment ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: appointment_id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Billing details for appointment
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Billing"

  /billings/{id}/payment-status:
    put:
      tags: [Billings]
      summary: Update payment status and auto-create invoice when paid
      description: |
        Update payment status for a billing. When payment_status is changed to "paid",
        an invoice will be automatically created with:
        - Consultation fee: Rp 200,000
        - Medication costs: Calculated from diagnosis
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [payment_status]
              properties:
                payment_status: { type: string, enum: [unpaid, waiting_payment, paid, failed] }
                invoice_url: { type: string }
      responses:
        "200":
          description: Payment status updated successfully (and invoice auto-created if paid)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }

  /billings/{id}/create-invoice:
    post:
      tags: [Billings]
      summary: Manually create invoice for a billing
      description: Create invoice manually (alternative to auto-creation on payment status update)
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "201":
          description: Invoice created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  invoice:
                    type: object
                    properties:
                      id: { type: integer }
                      billing_id: { type: integer }
                      user_id: { type: integer }
                      doctor_id: { type: integer }
                      consultation_fee: { type: number, format: float }
                      medication_cost: { type: number, format: float }
                      total_amount: { type: number, format: float }
                      invoice_date: { type: string, format: date-time }

  # Invoices
  /invoices/{id}:
    get:
      tags: [Billings]
      summary: Get invoice details by ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Invoice details with full information
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    type: object
                    properties:
                      invoice:
                        type: object
                        properties:
                          id: { type: integer }
                          billing_id: { type: integer }
                          user_id: { type: integer }
                          doctor_id: { type: integer }
                          consultation_fee: { type: number, format: float }
                          medication_cost: { type: number, format: float }
                          total_amount: { type: number, format: float }
                          invoice_date: { type: string, format: date-time }
                      user:
                        type: object
                        properties:
                          id: { type: integer }
                          full_name: { type: string }
                          email: { type: string }
                      doctor:
                        type: object
                        properties:
                          id: { type: integer }
                          full_name: { type: string }
                          specialization: { type: string }
                      appointment:
                        type: object
                        properties:
                          id: { type: integer }
                          appointment_date: { type: string, format: date-time }
                          status: { type: string }
                      diagnosis:
                        type: object
                        properties:
                          id: { type: integer }
                          notes: { type: string }
                          prescribed_medications: { type: string }
                      billing:
                        type: object
                        properties:
                          id: { type: integer }
                          payment_status: { type: string }
                          paid_at: { type: string, format: date-time }

  # Diagnoses
  /diagnoses:
    post:
      tags: [Diagnoses]
      summary: Create diagnosis and auto-generate billing (Rp 200.000 + medications)
      description: |
        Buat diagnosa untuk appointment. Billing akan dibuat otomatis dengan:
        - Biaya appointment: Rp 200.000
        - Biaya obat: Rp 50.000 per obat (jika ada prescribed_medications)
        
        Format prescribed_medications: "Obat1, Obat2, Obat3" (comma separated)
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [appointment_id, doctor_id, notes]
              properties:
                appointment_id: { type: integer }
                doctor_id: { type: integer }
                notes: { type: string }
                prescribed_medications: { type: string, description: "Comma-separated list of medications" }
      responses:
        "201":
          description: Diagnosis and billing created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    type: object
                    properties:
                      diagnosis:
                        $ref: "#/components/schemas/Diagnosis"
                      billing:
                        $ref: "#/components/schemas/Billing"
                      total_amount: { type: number, format: float }

  /diagnoses/{id}:
    get:
      tags: [Diagnoses]
      summary: Get diagnosis by ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Diagnosis details
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Diagnosis"

    put:
      tags: [Diagnoses]
      summary: Update diagnosis
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                notes: { type: string }
                prescribed_medications: { type: string }
      responses:
        "200":
          description: Diagnosis updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Diagnosis"
                  total_amount: { type: number, format: float }

  /diagnoses/appointment/{appointment_id}:
    get:
      tags: [Diagnoses]
      summary: Get diagnosis by appointment ID
      security: [{ BearerAuth: [] }]
      parameters:
        - in: path
          name: appointment_id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Diagnosis details for appointment
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  data:
                    $ref: "#/components/schemas/Diagnosis"
     
